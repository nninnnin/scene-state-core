## Invariants 레이어

Invariants는 데이터 무결성 검사를 위해 사용된다.

'데이터 무결성' 이란 내부 정책에 의해 정의된 데이터의 형태와 값에 대한 보증을 의미한다.

zod가 담당하는 스키마 유효성 검증과의 차이점은, 스키마 유효성 검증에서는 데이터의 타입과 값을 검증하는 기능을 한다면 무결성 검사에서는 참조 무결성을 검증하고 데이터의 중복을 검사하는 등 데이터 간의 관계나 위계와 같은 통합적인 무결성 검증을 맡아서 한다는 점이다. 이러한 검사는 zod와 같은 라이브러리로는 불가능하며, zod의 주 기능은 schema를 검증하는 것이다.

따라서 `assetInvariants` 메서드로 진행되는 데이터 무결성 검증은 상태 파이프라인 맨 마지막에 위치하는 방어선으로서 최종적으로 상태가 도메인 규칙과 시트템 제약을 위반하지 않는지 확인한다. 또한 해당 단계에서는 적극적인 수정이 아니라 거부(에러 반환)을 책임지며, sanitize와 같은 적극적인 수정은 zod의 스키마 검증이나 migration 단계에서 책임진다.

### Invariants on Load

- `assertInvariants('onload')` 는 외부 상태가 로드 될 때, 스키마 유효성 검증과 마이그레이션 이후에 상태 전체의 데이터 무결성을 확인하는 용도로 사용된다.

### Invariants on Update

- `assertInvariants('onupdate')` 는 상태가 업데이트 될 때마다 호출되며 아래와 같은 검증들을 수행한다. 각 상태의 업데이트 시 발생할 수 있는 무결성 검증을 포함하며, 추후 커맨드가 확장되었을 때에는 검증 비용을 낮추기 위해 도메인을 구분하여 부분적으로 검증을 수행하도록 업데이트 할 수 있는 여지가 존재한다.

- Entity
  - 엔티티 명 중복 검사
- Transform
  - 트랜스폼의 엔티티 참조 무결성 검사
